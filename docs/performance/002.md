---
outline: deep
---

# 本地无法复现线上页面卡顿

原因：不同网络条件、设备性能、浏览器版本都会造成差异，还有可能是地理位置原因，比如不同 CDN 节点响应差异，导致无法复现

解决方案：**用户端收集真实数据** 代替复现问题,即建立系统性的 RUM(真实用户监控) 体系。

## RUM 体系

作用：采集**真实用户访问数据** ，即用户的 **性能指标、环境信息和异常日志**。

目标：帮助开发者**还原现场**、定位问题、验证优化效果

### 采集性能数据

使用`PerformanceObserver`实时获取页面渲染性能数据并上报到服务器分析

```js
const observer = new PerformanceObserver((list) => {
  list.getEntries().forEach((entry) => {
    console.log(entry.name, entry.startTime, entry.duration);
    if (entry.entryType === "layout-shift") {
      console.log("CLS指标数据", entry.value);
    }
  });
});
// 监听关键指标
observer.observe({
  entryTypes: ["largest-contentful-paint", "first-input", "layout-shift"],
});
```

### 异常日志

- js 执行错误：`window.onerror`捕获
- 资源加载失败：`window.addEventListener('error',handler)`
- Promise 未处理异常：`unhandledrejection`

```js
window.addEventListener("error", (e) => {
  report({ type: "js-error", message: e.message });
});

window.addEventListener("unhandledrejection", (e) => {
  report({ type: "promise-rejection", message: e.reason });
});
```

### 环境信息

> 对信息按照设备、地区、版本聚合分析，快速定位共性问题

1. 用户设备型号/内存/分辨率
2. 操作系统/版本
3. 浏览器类型和版本
4. 网络类型和延迟
5. 用户地理位置(排查 cdn 节点)
