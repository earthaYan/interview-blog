# websocket 进度条

## 基础使用

1. new 浏览器自带的 WebSocket 对象就可以发起对 websocket 服务的连接
2. 四大监听：open,message,close,error
3. 需要进行 token 验证，防止非法请求

::: code-group

```js [服务端]
const express = require("express");
const expressWs = require("express-ws");
const cors = require("cors");

const app = express();
expressWs(app);
app.use(cors());
app.use(express.json());

// 存储所有连接的客户端
const clients = new Set();

// WebSocket路由
app.ws("/ws/progress", (ws, req) => {
  console.log("新的WebSocket连接");
  clients.add(ws);

  // 发送欢迎消息
  ws.send(
    JSON.stringify({
      type: "connected",
      message: "连接成功",
      timestamp: new Date().toISOString(),
    })
  );

  // 处理客户端消息
  ws.on("message", (message) => {
    try {
      const data = JSON.parse(message);
      console.log("收到客户端消息:", data);

      // 如果客户端请求开始任务
      if (data.type === "startTask") {
        startProgressTask(ws, data.taskId || "default");
      }
    } catch (error) {
      console.error("解析消息错误:", error);
    }
  });

  // 处理连接关闭
  ws.on("close", () => {
    console.log("客户端断开连接");
    clients.delete(ws);
  });

  // 处理错误
  ws.on("error", (error) => {
    console.error("WebSocket错误:", error);
    clients.delete(ws);
  });
});

// 模拟进度任务
function startProgressTask(ws, taskId) {
  let progress = 0;
  const total = 100;
  const interval = setInterval(() => {
    progress += 10;

    const progressData = {
      type: "progress",
      taskId: taskId,
      progress: progress,
      total: total,
      percentage: Math.round((progress / total) * 100),
      message: `正在处理任务 ${taskId}... ${progress}%`,
      timestamp: new Date().toISOString(),
    };

    // 发送进度更新
    if (ws.readyState === ws.OPEN) {
      ws.send(JSON.stringify(progressData));
    }

    // 完成时发送完成消息
    if (progress >= total) {
      clearInterval(interval);
      const completeData = {
        type: "complete",
        taskId: taskId,
        message: `任务 ${taskId} 已完成！`,
        timestamp: new Date().toISOString(),
      };

      if (ws.readyState === ws.OPEN) {
        ws.send(JSON.stringify(completeData));
      }
    }
  }, 500); // 每500ms更新一次进度
}

// 广播消息给所有客户端（可选功能）
function broadcast(message) {
  const data = JSON.stringify(message);
  clients.forEach((client) => {
    if (client.readyState === client.OPEN) {
      client.send(data);
    }
  });
}

// HTTP API：手动触发进度任务（可选）
app.post("/api/start-task", (req, res) => {
  const { taskId } = req.body;
  if (clients.size === 0) {
    return res.status(400).json({ error: "没有连接的客户端" });
  }

  // 给所有客户端发送任务开始消息
  broadcast({
    type: "taskStarted",
    taskId: taskId || "server-triggered",
    message: "服务器触发了新任务",
    timestamp: new Date().toISOString(),
  });

  res.json({ success: true, message: "任务已发送给所有客户端" });
});

const PORT = 3000;
app.listen(PORT, () => {
  console.log(`WebSocket服务器运行在 http://localhost:${PORT}`);
  console.log(`WebSocket端点: ws://localhost:${PORT}/ws/progress`);
});
```

```jsx [客户端]
import { useState, useEffect, useRef } from "react";

function Progress() {
  const [connected, setConnected] = useState(false);
  const [progress, setProgress] = useState(0);
  const [message, setMessage] = useState("");
  const [logs, setLogs] = useState([]);
  const wsRef = useRef(null);
  const [taskId, setTaskId] = useState("task-" + Date.now());

  useEffect(() => {
    // 组件卸载时关闭WebSocket连接
    return () => {
      if (wsRef.current) {
        wsRef.current.close();
      }
    };
  }, []);

  const connectWebSocket = () => {
    if (wsRef.current?.readyState === WebSocket.OPEN) {
      addLog("已经连接，无需重复连接");
      return;
    }

    const ws = new WebSocket("ws://localhost:3000/ws/progress");
    wsRef.current = ws;

    ws.onopen = () => {
      setConnected(true);
      addLog("WebSocket连接成功");
    };

    ws.onmessage = (event) => {
      try {
        const data = JSON.parse(event.data);
        handleMessage(data);
      } catch (error) {
        console.error("解析消息错误:", error);
        addLog("解析消息错误: " + error.message);
      }
    };

    ws.onerror = (error) => {
      console.error("WebSocket错误:", error);
      addLog("WebSocket连接错误");
    };

    ws.onclose = () => {
      setConnected(false);
      addLog("WebSocket连接已关闭");
    };
  };

  const handleMessage = (data) => {
    switch (data.type) {
      case "connected":
        addLog(`服务器消息: ${data.message}`);
        break;
      case "progress":
        setProgress(data.percentage);
        setMessage(data.message);
        addLog(`进度更新: ${data.percentage}% - ${data.message}`);
        break;
      case "complete":
        setProgress(100);
        setMessage(data.message);
        addLog(`任务完成: ${data.message}`);
        break;
      case "taskStarted":
        addLog(`新任务: ${data.message} - ${data.taskId}`);
        break;
      default:
        addLog(`收到消息: ${JSON.stringify(data)}`);
    }
  };

  const disconnectWebSocket = () => {
    if (wsRef.current) {
      wsRef.current.close();
      wsRef.current = null;
      setConnected(false);
      addLog("主动断开连接");
    }
  };

  const startTask = () => {
    if (!connected || wsRef.current?.readyState !== WebSocket.OPEN) {
      addLog("请先连接WebSocket");
      return;
    }

    const newTaskId = "task-" + Date.now();
    setTaskId(newTaskId);
    setProgress(0);
    setMessage("");

    wsRef.current.send(
      JSON.stringify({
        type: "startTask",
        taskId: newTaskId,
      })
    );

    addLog(`开始任务: ${newTaskId}`);
  };

  const addLog = (logMessage) => {
    setLogs((prev) => [
      ...prev,
      {
        message: logMessage,
        timestamp: new Date().toLocaleTimeString(),
      },
    ]);
  };

  const clearLogs = () => {
    setLogs([]);
  };

  return (
    <div className="app">
      <div className="container">
        <h1>WebSocket 实时进度演示</h1>

        <div className="controls">
          <button
            onClick={connectWebSocket}
            disabled={connected}
            className="btn btn-primary"
          >
            连接WebSocket
          </button>
          <button
            onClick={disconnectWebSocket}
            disabled={!connected}
            className="btn btn-secondary"
          >
            断开连接
          </button>
          <button
            onClick={startTask}
            disabled={!connected}
            className="btn btn-success"
          >
            开始任务
          </button>
          <button onClick={clearLogs} className="btn btn-info">
            清空日志
          </button>
        </div>

        <div className="status">
          <div
            className={`status-indicator ${
              connected ? "connected" : "disconnected"
            }`}
          >
            {connected ? "● 已连接" : "○ 未连接"}
          </div>
          <div className="task-id">任务ID: {taskId}</div>
        </div>

        <div className="progress-section">
          <div className="progress-header">
            <h2>进度</h2>
            <span className="percentage">{progress}%</span>
          </div>
          <div className="progress-bar-container">
            <div
              className="progress-bar"
              style={{ width: `${progress}%` }}
            ></div>
          </div>
          {message && <div className="progress-message">{message}</div>}
        </div>

        <div className="logs-section">
          <h2>日志</h2>
          <div className="logs-container">
            {logs.length === 0 ? (
              <div className="log-empty">暂无日志</div>
            ) : (
              logs.map((log, index) => (
                <div key={index} className="log-item">
                  <span className="log-time">[{log.timestamp}]</span>
                  <span className="log-message">{log.message}</span>
                </div>
              ))
            )}
          </div>
        </div>
      </div>
    </div>
  );
}

export default Progress;
```

:::
