# 代码质量管理

- extends:引入已经定义好的 ESLint 规则集合,自动启用
- plugins:引入新的规则和功能，不会自动启用，需要在 rules 或 extends 中显式使用

## js

配置文件：`.eslintrc.cjs`,`.eslintignore`

插件：

::: code-group

```json
{
  "devDependencies": {
    "eslint": "^8.57.0",
    "@typescript-eslint/parser": "^7.2.0",
    "@typescript-eslint/eslint-plugin": "^7.2.0",
    "eslint-plugin-prettier": "^4.2.1",
    "eslint-config-prettier": "^8.5.0",
    "eslint-plugin-react-hooks": "^4.6.0",
    "eslint-plugin-react-refresh": "^0.4.6",
    "eslint-config-react-app": "^7.0.1"
  }
}
```

```js [配置文件]
module.exports = {
  env: { browser: true, es2020: true },
  extends: [
    "eslint:recommended",
    "plugin:prettier/recommended",
    "plugin:react/jsx-runtime",
    "plugin:@typescript-eslint/recommended",
    "plugin:react-hooks/recommended",
  ],
  parser: "@typescript-eslint/parser",
  plugins: ["react-refresh"],
  globals: {
    JSX: true,
  },
  rules: {
    "@typescript-eslint/no-empty-interface": [
      "error",
      {
        allowSingleExtends: true,
      },
    ],
    "@typescript-eslint/no-explicit-any": ["off"],
    "react/display-name": 0,
    "react/prop-types": 0,
    "@typescript-eslint/triple-slash-reference": 0,
    "@typescript-eslint/no-unused-vars": 1,
  },
};
```

```plain [忽略文件]
src/**/*.test.ts
src/**/*.test.tsx
src/**/*.test.js
src/**/*.test.jsx
src/testUtils/**/*
src/locale/ch-language
src/locale/en-language
src/api
node_modules
.eslint.json
vite.config.mjs

catvertor/**/*
config/**/*
dependencies/**/*
dictionaries/**/*
documents/**/*
node_modules/**/*
public/**/*
scripts/**/*
dist/**/*
src/registerServiceWorker.ts
jest.config.js

```

:::

## css

文件：`.stylelintrc.cjs`,`.stylelintignore`

::: code-group

```json [依赖项]
{
  "devDependencies": {
    "eslint": "^8.57.0",
    "@typescript-eslint/parser": "^7.2.0",
    "@typescript-eslint/eslint-plugin": "^7.2.0",
    "eslint-plugin-prettier": "^4.2.1",
    "eslint-config-prettier": "^8.5.0",
    "eslint-plugin-react-hooks": "^4.6.0",
    "eslint-plugin-react-refresh": "^0.4.6",
    "eslint-config-react-app": "^7.0.1"
  }
}
```

```js [配置文件]
module.exports = {
  extends: [
    "stylelint-config-standard-less",
    "stylelint-config-prettier",
    "stylelint-config-recommended",
  ],
  plugins: ["stylelint-prettier"],
  // 需要忽略检测的文件类型
  ignoreFiles: [
    "node_modules/**/*.less",
    "node_modules/**/*.css",
    "**/*.ts",
    "**/*.tsx",
    "**/*.js",
    "**/*.test.tsx.snap",
  ],
  //   为特定文件或文件夹单独指定规则或解析
  overrides: [
    {
      files: "src/**/*.less",
      customSyntax: "postcss-less",
    },
  ],
  rules: {
    // 关闭规则 null
    "comment-empty-line-before": null,
    "selector-descendant-combinator-no-non-space": null,
    "no-descending-specificity": null,
    "function-comma-newline-after": null,
    "no-missing-end-of-source-newline": null,
    "font-family-no-missing-generic-family-keyword": null,
    "property-no-unknown": [
      // 不允许未知的样式属性
      null,
      {
        ignoreProperties: ["composes", ":global"],
      },
    ],
    "selector-pseudo-class-no-unknown": [
      // 不允许未知的选择器
      null,
      {
        ignorePseudoClasses: [":global", ":horizontal", ":vertical"],
      },
    ],
    "selector-class-pattern": [
      ".*",
      {
        resolveNestedSelectors: true,
      },
    ],
    "at-rule-no-unknown": null,
    "import-notation": null,
    "color-hex-length": null,
    "alpha-value-notation": null,
    "no-invalid-double-slash-comments": null,
    "color-function-notation": "legacy",
    "selector-not-notation": ["simple", "complex"],
    "selector-no-vendor-prefix": [
      true,
      {
        // 忽略特定选择器的前缀检查
        ignoreSelectors: [
          "::-webkit-full-screen",
          "::-webkit-scrollbar",
          "::-webkit-scrollbar-thumb",
        ],
      },
    ],
  },
};
```

```plain [忽略文件]
src/**/__snapshots__/**
src/**/public/**/**
src/**/locale/**/**
src/**/assets/**/**
src/**/coverage/**/**
**/coverage/**/*,
**/node_modules/**/*,
**/*.snap,
**/*.md,
**/*.ts,
**/*.tsx,
**/*.js,
**/*.jsx,
**/*.svg,
**/*.png
dist/**

```

:::

## 代码格式化

vscode 安装 prettier 插件

文件：`.prettierrc`

```json
{
  "tabWidth": 2,
  "semi": true,
  "printWidth": 80,
  "trailingComma": "none",
  "arrowParens": "always",
  "proseWrap": "preserve",
  "useTabs": false,
  "singleQuote": true,
  "bracketSpacing": true
}
```

## ci/cd

::: code-group

```makefile [makefile]
DOCKER_IMAGE  ?= reg.actiontech.com/actiontech/node:21.7.3
RELEASE_FTPD_HOST ?= ftpadmin:KFQsB9g0aut7@10.186.18.90
RELEASE ?= qa

override PROJECT_NAME  = template-ui #  todo: 根据需要自行更改版本
override MAIN_MODULE   = ${shell pwd}
override VERSION = 9.9.9.9
override DOCKER        = $(shell which docker)
override WEBPACK_NEWFE_REL = ${shell pwd}
override WEBPACK_NEWFE = ${shell pwd}
override GIT_VERSION = $(shell git rev-parse --abbrev-ref HEAD)${CUSTOM} $(shell git rev-parse HEAD)

OUTER_BUILD_NAME = $(PROJECT_NAME).tar.gz
FTP_BUILD_NAME = $(PROJECT_NAME)-$(VERSION).tar.gz

default: docker_build

pull_image:
	$(DOCKER) pull ${DOCKER_IMAGE}

docker_install_node_modules:
	$(DOCKER) run -v $(MAIN_MODULE):/usr/src/app -w /usr/src/app --rm $(DOCKER_IMAGE) sh -c "yarn config set strict-ssl false && yarn install"

docker_check: pull_image docker_install_node_modules
	$(DOCKER) run -v $(MAIN_MODULE):/usr/src/app -w /usr/src/app --rm $(DOCKER_IMAGE) yarn checker

# docker_test: pull_image docker_install_node_modules
# 	$(DOCKER) run -v $(MAIN_MODULE):/usr/src/app -w /usr/src/app --rm $(DOCKER_IMAGE) yarn test

docker_build: pull_image docker_install_node_modules
	$(DOCKER) run -v $(MAIN_MODULE):/usr/src/app -w /usr/src/app --rm $(DOCKER_IMAGE) sh -c "yarn build && echo 'template-ui: $(GIT_VERSION)' > ./dist/version.txt && tar zcf $(OUTER_BUILD_NAME) ./dist"

docker_clean:
	$(DOCKER) run -v $(MAIN_MODULE):/usr/src/app -w /usr/src/app --rm $(DOCKER_IMAGE) sh -c "git config --global --add safe.directory /usr/src/app && git clean -dfx"

# todo： 注意确认上传的文件目录
upload:
	curl -T $(OUTER_BUILD_NAME)  \
	ftp://$(RELEASE_FTPD_HOST)/actiontech-$(PROJECT_NAME)/$(RELEASE)/$(VERSION)/$(FTP_BUILD_NAME) --ftp-create-dirs

```

```bash [gitlab文件]
code-check:
  script:
    - make docker_check
  after_script:
    - make docker_clean
  only:
    - merge_request
  tags:
    - docker
```

:::
