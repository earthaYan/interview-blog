# 前端性能优化(3)

## 图片加载优化

从三个角度进行优化

1. 资源选择：
   - 格式选择：在上传资源的时候，优先采用 avif 和 webp 这种较新的格式，结合 picture 标签自上而下检查实现优雅回退；
   - 内容选择：对于 logo/图标类这种优先使用 svg 格式，不失真且体积较小，可以通过 css 修改图片

::: tip
webP 格式：在图片压缩率和兼容性之间达到了平衡，体积只有普通图片资源的 25%~35%

avif 格式：体积更小，但兼容性较差，不兼容 chrome 85 以下的浏览器
:::

2. 加载策略：核心思想是按需加载，避免浪费
   - 响应式图片：使用 image 标签的 srcset,size 属性为不同的设备提供不同尺寸的图片
   - 懒加载：延迟加载非视口内的图片，比如给非首屏展示的 image 添加 loading=lazy 属性，如果需要更精细控制，比如自定义占位符或者添加加载动画，可以使用 IntersectionObserver 监听对应元素是否进入视口范围
3. 分发链路：通过 CDN 提高分发效率，另外一些 CDN 服务商提供了图片处理服务，只需要上传一张原图，请求图片的时候在 url 上增加一个参数，CDN 就会实现动态裁剪、缩放、添加水印以及转换格式等功能，将这部分内容从前端业务代码上剥离

## 大量图标加载

原则：减少请求+高效复用+易于维护+样式控制

传统解决方案：

- icon-font：把所有图标打包成一个文件，然后通过 CSS 来调用和样式化这些图标

最新解决方案：SVG 雪碧图，一次请求加载，按需取用

```html
<svg style="display: none;">
  <symbol id="icon-home" viewBox="0 0 24 24">
    <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z" />
  </symbol>
</svg>

<svg class="icon">
  <use xlink:href="#icon-home"></use>
</svg>
```

## 字体加载优化

使用@font-face 自定义字体，其中使用`font-display`属性可以优化加载性能。

原理：字体显示分为 2 种情况 FOUT 和 FOIT。FOUT 指的是默认展示系统字体，等自定义字体加载完成后重新显示，缺点是会出现闪烁，视觉不连贯。而 FOIT 指的是阻塞渲染，等自定义字体加载完成后再显示，缺点是弱网环境下容易出现白屏。

实际开发中通常会按内容类型分层配置。

属性值：

1. swap:会立刻使用后备字体，自定义字体加载后替换；适合新闻/博客这种纯展示类型
2. block:有 3 秒阻塞空白期，如果期间加载成功则显示自定义字体，超时后使用后备字体；适合品牌 logo、 关键标题、口号
3. fallback:短暂阻塞 100ms 后显示回退字体，3 秒内加载完成则替换；适合导航菜单、按钮文字或一般的 ui 界面
4. optional:短暂阻塞 100ms，浏览器根据网络条件自主决定是否加载自定义文件，适合装饰字体等类型

## HTTP2 解决了多路复用问题，还需要合并 js，css 资源吗

回答：不再需要像 http1.1 时代那样把资源做极限合并，而是应该转向更精细化的资源管理策略，可以用代码分割、按需加载策略去充分利用 http2 的多路复用优势，把代码拆分为独立且可被精细化缓存的模块，同时通过优先级设置，优化关键的渲染路径。但请求本身依然存在开销，且 http2 只实现了应用层的队头阻塞问题，无法规避 TCP 底层的队头阻塞问题，因此对于大量极小的文件或为了提升压缩率，进行适当的策略性合并依旧是必要的。
