# 性能优化(2)

## 核心指标

1. 加载速度：LCP，即最核心内容绘制时长，也是用户感受最明显的，其不应该超过 2.5 秒
2. 视觉稳定性：CLS，即累积布局偏移，简单说就是页面抖动严重程度，其不应该超过 0.1
3. 交互响应性：INP,每次交互到下一次绘制的时长，其不应该超过 200 毫秒，取代了之前的 FID(只有首次交互)

## 获取性能数据

卡顿是用户感知上的，我们需要将其转换为技术语言，以便优化。

性能数据分为：

- 实验室数据(开发调试环境)：通过 dev tool 的 lighthouse 工具跑报告
- 现场数据(真实线上环境)：通过线上监控获取，比如谷歌的 web-vitals 库

## 线上卡顿，本地无问题

### 解决方案

1. 让用户清除缓存
2. 在本地模拟用户环境，比如相同的浏览器版本，工单上的操作步骤

如果上述 2 种方式都不能复现或者解决问题，则需要基于真实的用户监控（RUM 体系）去排查。排查路径遵循闭环：

1. 量化性能：采集用户真实的性能指标，异常日志和环境信息
2. 捕获异常：数据上报监控平台，通过数据可视化和聚合分析找到异常位置和共性
3. 还原现场：提出假设，回到本地用开发者工具精准模拟线上环境

## script 导致页面加载缓慢

本质问题：浏览器渲染被阻塞，原因是浏览器默认遇到 script 会暂停一切工作，去下载并执行脚本。

思路：先看依赖再定策略

首先看脚本是否依赖 DOM

- 不依赖 DOM：async 属性，并行下载脚本，下载完立刻执行;滥用会导致执行顺序混乱，引发偶发性 bug
- 依赖 DOM:defer 属性，并行下载脚本，并在 html 解析完执行;不会阻塞渲染的同时又可以保证依赖关系

async 属性适用于独立的脚本，比如广告脚本和分析脚本，defer 适用于依赖 DOM 或者其他脚本内容的脚本
