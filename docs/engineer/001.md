# å·¥ç¨‹åŒ–

## webpack åŸºç¡€é…ç½®

### webpack æ‰§è¡Œæµç¨‹

- åˆå§‹åŒ–é˜¶æ®µï¼šè¯»å–é…ç½® â†’ åˆ›å»º Compiler â†’ æ³¨å†Œæ’ä»¶
- æ„å»ºé˜¶æ®µï¼šä»å…¥å£æ„å»ºæ¨¡å— â†’ ä½¿ç”¨ Loader è½¬æ¢ â†’ æ„å»ºä¾èµ–å›¾
- æ‰“åŒ…é˜¶æ®µï¼šç”Ÿæˆ Chunk â†’ ç”Ÿæˆæœ€ç»ˆ bundle â†’ å†™å…¥ç£ç›˜

æ­¥éª¤

1. æ–°å»ºæ–‡ä»¶å¤¹ï¼Œåœ¨æ–‡ä»¶å¤¹å†…æ‰§è¡Œ`npm init`ï¼Œç”Ÿæˆæœ€åŸå§‹çš„ package.json æ–‡ä»¶
2. å®‰è£… webpack ä¾èµ–`npm install webpack webpack-cli webpack-dev-server -D`
3. æ–°å»ºé…ç½®æ–‡ä»¶ webpack.config.js å¹¶è¿›è¡Œç¼–è¾‘
4. åœ¨ package.json æ–‡ä»¶æ·»åŠ  scripts

å¼€å‘ç¯å¢ƒï¼šwebpack-dev-serverï¼›ç”Ÿäº§ç¯å¢ƒï¼šwebpack
::: code-group

```js [webpack.config.js]
const path = require("path");
const HtmlWebpackPlugins = require("html-webpack-plugin");

module.exports = {
  mode: "development",
  entry: path.join(__dirname, "src", "index.js"),
  output: {
    filename: "bundle.js",
    path: path.join(__dirname, "dist"),
  },
  plugins: [
    new HtmlWebpackPlugins({
      template: path.join(__dirname, "src", "index.html"),
      filename: "index.html",
    }),
  ],
  devServer: {
    port: 3000,
  },
};
```

```js [webpack.prod.js]
const path = require("path");
const HtmlWebpackPlugins = require("html-webpack-plugin");

module.exports = {
  mode: "production",
  entry: path.join(__dirname, "src", "index.js"),
  output: {
    filename: "bundle.[contenthash].js", //å¦‚æœå†…å®¹ä¸å˜åˆ™æ–‡ä»¶åç§°å°±ä¸å˜
    path: path.join(__dirname, "dist"),
  },
  plugins: [
    new HtmlWebpackPlugins({
      template: path.join(__dirname, "src", "index.html"),
      filename: "index.html",
    }),
  ],
  module: {
    rules: [
      {
        test: /\.js$/,
        loader: "babel-loader",
        include: path.join(__dirname, "src"),
        exclude: /node_modules/,
      },
    ],
  },
};
```

:::

ä¸åŒ mode çš„åŒºåˆ«ï¼š
| å€¼ | ä½œç”¨ |
| ------------- | -------------------------------------------------------------- |
| `development` | å¼€å‘æ¨¡å¼ï¼šæ„å»ºé€Ÿåº¦å¿«ï¼Œä¿ç•™å®Œæ•´è°ƒè¯•ä¿¡æ¯ï¼Œä¸å‹ç¼©ä»£ç ï¼Œå¯ç”¨æ˜“è¯»çš„æ–‡ä»¶åå’Œ source mapã€‚ |
| `production` | ç”Ÿäº§æ¨¡å¼ï¼šå¯ç”¨ä»£ç å‹ç¼©ã€Tree Shakingã€scope hoisting ç­‰ä¼˜åŒ–ï¼Œæé«˜æ€§èƒ½ï¼Œå‡å°‘ bundle å¤§å°ã€‚ |
| `none` | ä¸å¯ç”¨ä»»ä½•é»˜è®¤ä¼˜åŒ–ï¼Œéœ€è¦æ‰‹åŠ¨é…ç½®æ‰€æœ‰ä¼˜åŒ–ã€‚ |

## babel åŸºç¡€é…ç½®

ä½œç”¨ï¼šå°† es6 è¯­æ³•è½¬æ¢ä¸º es5

::: tip
Q:ä¸ºä»€ä¹ˆæœ‰äº† babel è¿˜ä¼šå­˜åœ¨æµè§ˆå™¨å…¼å®¹é—®é¢˜ï¼Ÿï¼Ÿ

A:babel åªæ˜¯è½¬æ¢è¯­æ³•ï¼Œä½†æ˜¯ä¸€äº›æ–°çš„æµè§ˆå™¨ APIï¼Œå¦‚ fetchï¼Œpromise ç­‰å¹¶ä¸ä¼šè¢«è½¬æ¢,è¿™äº›éœ€è¦é€šè¿‡ polyfill è§£å†³
:::

æ­¥éª¤ï¼š

1. å®‰è£…ä¾èµ–`npm install @babel/core @babel/preset-env babel-loader -D`
2. æ–°å»ºé…ç½®æ–‡ä»¶.babelrc
3. åœ¨ webpack ä¸­é…ç½®é’ˆå¯¹ js çš„ babel

::: code-group

```json [.babelrc]
{
  "presets": ["@babel/preset-env"]
}
```

```js [webpack.config.js]
module.exports = {
  module: {
    rules: [
      {
        test: /\.js$/,
        loader: "babel-loader",
        include: path.join(__dirname, "src"),
        exclude: /node_modules/,
      },
    ],
  },
};
```

:::

ä¸‰ä¸ªä¾èµ–è¯¦è§£ï¼š

- @babel/core:æ ¸å¿ƒï¼Œæ‰§è¡Œè¯­æ³•è½¬æ¢åŠŸèƒ½
- @babel/preset-env:babel é…ç½®é›†åˆ
- babel-loader:ç»™ webpack ä½¿ç”¨çš„æ’ä»¶

## å¸¸è§ webpack ä¼˜åŒ– é…ç½®

1. Tree Shakingï¼š`usedExports: true`ï¼Œåˆ é™¤æœªç”¨ä»£ç 
2. JS å‹ç¼©ï¼šUglifyJsPlugin + å¹¶è¡Œ + ç¼“å­˜ + å»æ‰ console
3. CSS å‹ç¼©ï¼šMiniCssExtractPlugin + OptimizeCSSAssetsPlugin
4. åˆ†åŒ…ï¼šsplitChunks æå–å…¬å…±æ¨¡å—
5. é•¿ç¼“å­˜ï¼š[chunkhash] + [contenthash]
6. å¿½ç•¥æ— ç”¨æ¨¡å—ï¼šIgnorePlugin

```js
const path = require("path");
const MiniCssExtractPlugin = require("mini-css-extract-plugin");
const OptimizeCSSAssetsPlugin = require("optimize-css-assets-webpack-plugin");
const TerserPlugin = require("terser-webpack-plugin"); // ğŸ”¹ ä½¿ç”¨ TerserPlugin æ›¿ä»£ UglifyJsPlugin
const webpack = require("webpack");

module.exports = {
  mode: "production",

  output: {
    path: path.resolve(__dirname, "dist"),
    filename: "[name].[chunkhash].js", // ğŸ”¹ é•¿ç¼“å­˜: chunkhash ä¿è¯æ–‡ä»¶å†…å®¹æ”¹å˜æ‰æ›´æ–°
    chunkFilename: "[name].[chunkhash].js", // ğŸ”¹ å¼‚æ­¥ chunk ä¹Ÿä½¿ç”¨é•¿ç¼“å­˜
    publicPath: "/",
  },

  module: {
    rules: [
      // ğŸ”¹ JS/JSX ä¼˜åŒ–
      {
        test: /\.jsx?$/,
        include: path.resolve(__dirname, "src"),
        use: [
          {
            loader: "babel-loader",
            options: {
              cacheDirectory: true, // ğŸ”¹ ç¼“å­˜åŠ é€ŸäºŒæ¬¡æ„å»º
            },
          },
        ],
      },
      // ğŸ”¹ CSS ä¼˜åŒ–
      {
        test: /\.css$/,
        use: [
          MiniCssExtractPlugin.loader, // ğŸ”¹ æŠ½å– CSS åˆ°å•ç‹¬æ–‡ä»¶
          "css-loader",
          "postcss-loader", // ğŸ”¹ å¯ä»¥åŠ  autoprefixerã€cssnano
        ],
      },
      // ğŸ”¹ å›¾ç‰‡ä¼˜åŒ–
      {
        test: /\.(png|jpe?g|gif|svg)$/,
        use: [
          {
            loader: "file-loader",
            options: {
              name: "[name].[hash].[ext]", // ğŸ”¹ æ–‡ä»¶å hash ç¼“å­˜
              outputPath: "images/",
            },
          },
        ],
      },
    ],
  },

  optimization: {
    // ğŸ”¹ Tree Shaking åˆ é™¤æœªä½¿ç”¨ä»£ç 
    usedExports: true,

    // ğŸ”¹ JS/CSS å‹ç¼©
    minimize: true,
    minimizer: [
      new TerserPlugin({
        parallel: true, // ğŸ”¹ å¤šçº¿ç¨‹å‹ç¼©
        cache: true, // ğŸ”¹ ç¼“å­˜åŠ é€ŸäºŒæ¬¡æ„å»º
        terserOptions: {
          compress: {
            drop_console: true, // ğŸ”¹ å»æ‰ console
            drop_debugger: true, // ğŸ”¹ å»æ‰ debugger
          },
          output: {
            comments: false, // ğŸ”¹ ç§»é™¤æ³¨é‡Š
          },
        },
      }),
      new OptimizeCSSAssetsPlugin({}), // ğŸ”¹ å‹ç¼© CSS
    ],

    // ğŸ”¹ åˆ†åŒ…
    splitChunks: {
      chunks: "all", // ğŸ”¹ å…¬å…±æ¨¡å—æŠ½å–
    },
  },

  plugins: [
    // ğŸ”¹ æŠ½å– CSS
    new MiniCssExtractPlugin({
      filename: "[name].[contenthash].css", // ğŸ”¹ CSS é•¿ç¼“å­˜
      chunkFilename: "[name].[contenthash].css",
    }),

    // ğŸ”¹ å¿½ç•¥ä¸å¿…è¦çš„æ¨¡å—ï¼ˆå¦‚ moment localeï¼‰
    new webpack.IgnorePlugin(/^\.\/locale$/, /moment$/),
  ],

  resolve: {
    extensions: [".js", ".jsx"],
    alias: {
      "@": path.resolve(__dirname, "src"),
    },
  },
};
```
